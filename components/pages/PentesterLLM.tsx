import { useState, useEffect } from 'react';
import { ChevronDown, ChevronUp } from 'lucide-react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '../ui/select';

interface LogEntry {
  id: number;
  phase: 'Recon' | 'Crawl' | 'Exploit' | 'Verify';
  status: 'Running' | 'Completed' | 'Warning' | 'Error';
  message: string;
  timestamp: string;
  details?: string;
}

const organizations = ['CyberCorp Inc.', 'TechSecure Ltd.', 'DataGuard Systems'];
const hosts = [
  'api.cybercorp.com',
  'webapp.cybercorp.io',
  'admin.example.com',
  'app.example.com',
];

const initialLogs: LogEntry[] = [
  {
    id: 1,
    phase: 'Recon',
    status: 'Completed',
    message: 'Target reconnaissance initiated',
    timestamp: '10:23:15',
    details: 'Scanning target infrastructure and identifying entry points',
  },
  {
    id: 2,
    phase: 'Recon',
    status: 'Completed',
    message: 'DNS enumeration completed - 12 subdomains discovered',
    timestamp: '10:23:18',
  },
  {
    id: 3,
    phase: 'Recon',
    status: 'Completed',
    message: 'Port scan completed - 8 open ports identified',
    timestamp: '10:23:22',
  },
  {
    id: 4,
    phase: 'Crawl',
    status: 'Completed',
    message: 'Web crawler initialized for target endpoints',
    timestamp: '10:23:28',
  },
  {
    id: 5,
    phase: 'Crawl',
    status: 'Completed',
    message: 'Discovered 47 endpoints across application',
    timestamp: '10:23:35',
  },
  {
    id: 6,
    phase: 'Crawl',
    status: 'Warning',
    message: 'Rate limit detected - adjusting crawl speed',
    timestamp: '10:23:40',
  },
  {
    id: 7,
    phase: 'Exploit',
    status: 'Running',
    message: 'Testing authentication bypass vectors',
    timestamp: '10:23:45',
  },
  {
    id: 8,
    phase: 'Exploit',
    status: 'Running',
    message: 'Analyzing SQL injection points in /api/login',
    timestamp: '10:23:50',
  },
];

const phaseColors = {
  Recon: 'text-blue-600',
  Crawl: 'text-purple-600',
  Exploit: 'text-orange-600',
  Verify: 'text-green-600',
};

const statusColors = {
  Running: 'bg-blue-50 text-blue-700 border-blue-200',
  Completed: 'bg-green-50 text-green-700 border-green-200',
  Warning: 'bg-amber-50 text-amber-700 border-amber-200',
  Error: 'bg-red-50 text-red-700 border-red-200',
};

interface PentesterLLMProps {
  isDarkMode?: boolean;
}

export function PentesterLLM({ isDarkMode = true }: PentesterLLMProps) {
  const [logs, setLogs] = useState<LogEntry[]>(initialLogs);
  const [progress, setProgress] = useState(45);
  const [collapsedPhases, setCollapsedPhases] = useState<Set<string>>(new Set());

  useEffect(() => {
    const interval = setInterval(() => {
      setProgress((prev) => (prev >= 100 ? 100 : prev + 0.5));
    }, 200);
    return () => clearInterval(interval);
  }, []);

  const togglePhase = (phase: string) => {
    const newCollapsed = new Set(collapsedPhases);
    if (newCollapsed.has(phase)) {
      newCollapsed.delete(phase);
    } else {
      newCollapsed.add(phase);
    }
    setCollapsedPhases(newCollapsed);
  };

  const groupedLogs = logs.reduce((acc, log) => {
    if (!acc[log.phase]) acc[log.phase] = [];
    acc[log.phase].push(log);
    return acc;
  }, {} as Record<string, LogEntry[]>);

  const phases = ['Recon', 'Crawl', 'Exploit', 'Verify'] as const;

  return (
    <div className={`min-h-screen transition-colors duration-300 ${isDarkMode ? 'bg-[#0f1117]' : 'bg-gray-50'}`}>
      {/* Header with Dropdowns */}
      <div className={`px-8 py-6 border-b transition-colors ${isDarkMode ? 'border-white/[0.08]' : 'border-gray-200'}`}>
        <div className="max-w-7xl mx-auto">
          <h1 className={`text-2xl mb-6 transition-colors ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
            Pentester LLM Live Preview
          </h1>
          
          <div className="flex items-center gap-4">
            {/* Organization Selector */}
            <div className="flex flex-col gap-1.5 min-w-[240px]">
              <label className={`text-sm transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Organization
              </label>
              <Select defaultValue={organizations[0]}>
                <SelectTrigger className={`h-11 rounded-lg border transition-colors ${
                  isDarkMode 
                    ? 'bg-[#1a1d2e] border-white/[0.12] text-white hover:border-white/[0.2]' 
                    : 'bg-white border-gray-300 text-gray-900 hover:border-gray-400 shadow-sm'
                }`}>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent className={isDarkMode ? 'bg-[#1a1d2e] border-white/[0.12]' : 'bg-white border-gray-200'}>
                  {organizations.map((org) => (
                    <SelectItem 
                      key={org} 
                      value={org}
                      className={isDarkMode ? 'text-white focus:bg-white/[0.05]' : 'text-gray-900 focus:bg-gray-100'}
                    >
                      {org}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Host Selector */}
            <div className="flex flex-col gap-1.5 min-w-[280px]">
              <label className={`text-sm transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Target Host
              </label>
              <Select defaultValue={hosts[0]}>
                <SelectTrigger className={`h-11 rounded-lg border transition-colors ${
                  isDarkMode 
                    ? 'bg-[#1a1d2e] border-white/[0.12] text-white hover:border-white/[0.2]' 
                    : 'bg-white border-gray-300 text-gray-900 hover:border-gray-400 shadow-sm'
                }`}>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent className={isDarkMode ? 'bg-[#1a1d2e] border-white/[0.12]' : 'bg-white border-gray-200'}>
                  {hosts.map((host) => (
                    <SelectItem 
                      key={host} 
                      value={host}
                      className={isDarkMode ? 'text-white focus:bg-white/[0.05]' : 'text-gray-900 focus:bg-gray-100'}
                    >
                      {host}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
        </div>
      </div>

      {/* Console Panel */}
      <div className="max-w-7xl mx-auto px-8 py-8">
        <div className={`rounded-2xl overflow-hidden shadow-xl transition-all duration-300 ${
          isDarkMode 
            ? 'bg-[#1a1d2e] border border-white/[0.08] hover:shadow-2xl' 
            : 'bg-white border border-gray-200 hover:shadow-2xl'
        }`}>
          {/* Progress Bar */}
          <div className={`h-1 transition-colors ${isDarkMode ? 'bg-white/[0.05]' : 'bg-gray-100'}`}>
            <div
              className="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 transition-all duration-300 ease-out"
              style={{ width: `${progress}%` }}
            />
          </div>

          {/* Console Header */}
          <div className={`px-6 py-4 border-b transition-colors ${isDarkMode ? 'border-white/[0.08]' : 'border-gray-200'}`}>
            <div className="flex items-center justify-between">
              <div>
                <h2 className={`text-lg transition-colors ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                  Testing Console
                </h2>
                <p className={`text-sm mt-0.5 transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Real-time penetration testing analysis
                </p>
              </div>
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse" />
                  <span className={`text-sm transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Testing in progress
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* Phase Sections */}
          <div className="divide-y divide-white/[0.05]">
            {phases.map((phase) => {
              const phaseLogs = groupedLogs[phase] || [];
              const isCollapsed = collapsedPhases.has(phase);
              const phaseStatus = phaseLogs.length > 0 ? phaseLogs[phaseLogs.length - 1].status : 'Running';

              return (
                <div key={phase} className="transition-colors">
                  {/* Phase Header */}
                  <button
                    onClick={() => togglePhase(phase)}
                    className={`w-full px-6 py-4 flex items-center justify-between transition-all ${
                      isDarkMode 
                        ? 'hover:bg-white/[0.02]' 
                        : 'hover:bg-gray-50'
                    }`}
                  >
                    <div className="flex items-center gap-3">
                      {isCollapsed ? (
                        <ChevronDown className={`w-4 h-4 transition-colors ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`} />
                      ) : (
                        <ChevronUp className={`w-4 h-4 transition-colors ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`} />
                      )}
                      <span className={`font-medium ${isDarkMode ? phaseColors[phase].replace('600', '400') : phaseColors[phase]}`}>
                        {phase}
                      </span>
                      <span className={`text-sm transition-colors ${isDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                        {phaseLogs.length} {phaseLogs.length === 1 ? 'step' : 'steps'}
                      </span>
                    </div>
                    
                    <div className={`px-3 py-1 rounded-full text-xs border transition-colors ${
                      isDarkMode 
                        ? statusColors[phaseStatus].replace('50', '500/10').replace('700', '400').replace('200', '500/20')
                        : statusColors[phaseStatus]
                    }`}>
                      {phaseStatus}
                    </div>
                  </button>

                  {/* Phase Logs */}
                  {!isCollapsed && phaseLogs.length > 0 && (
                    <div className={`px-6 pb-4 space-y-2 animate-in fade-in duration-300 ${
                      isDarkMode ? 'bg-white/[0.01]' : 'bg-gray-50/50'
                    }`}>
                      {phaseLogs.map((log, index) => (
                        <div
                          key={log.id}
                          className={`pl-7 py-2.5 rounded-lg transition-all duration-300 ${
                            isDarkMode 
                              ? 'hover:bg-white/[0.03]' 
                              : 'hover:bg-white hover:shadow-sm'
                          }`}
                          style={{
                            animation: `fadeIn 0.4s ease-out ${index * 0.1}s both`,
                          }}
                        >
                          <div className="flex items-start gap-3">
                            <span className={`text-xs font-mono shrink-0 mt-0.5 transition-colors ${
                              isDarkMode ? 'text-gray-500' : 'text-gray-500'
                            }`}>
                              {log.timestamp}
                            </span>
                            <div className="flex-1 min-w-0">
                              <p className={`text-sm transition-colors ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {log.message}
                              </p>
                              {log.details && (
                                <p className={`text-xs mt-1 transition-colors ${isDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                  {log.details}
                                </p>
                              )}
                            </div>
                            <div className={`px-2 py-0.5 rounded text-xs border shrink-0 transition-colors ${
                              isDarkMode 
                                ? statusColors[log.status].replace('50', '500/10').replace('700', '400').replace('200', '500/20')
                                : statusColors[log.status]
                            }`}>
                              {log.status}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      <style>{`
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(8px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      `}</style>
    </div>
  );
}
